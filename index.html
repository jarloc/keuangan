<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KEUANGAN PRIBADI</title>

<!-- ===== FIREBASE (SCRIPT TAG / COMPAT) ===== -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCcBqGjq9ZN4Cv-pDfNqaJ2QxnqSqzzPHE",
    authDomain: "keuangan-3ae83.firebaseapp.com",
    projectId: "keuangan-3ae83",
    storageBucket: "keuangan-3ae83.firebasestorage.app",
    messagingSenderId: "988326680959",
    appId: "1:988326680959:web:c2c39e4bed6cdf9c66a24a"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  /* ===== KUNCI MASALAH RELOAD (JANGAN DIHAPUS) ===== */
  auth.setPersistence(firebase.auth.Auth.Persistence.NONE);
</script>

<style>
:root{--gold:#d4af37;}
body,html{margin:0;height:100%;background:#000;color:#fff;font-family:Segoe UI}
button {
    cursor: pointer;
    border-radius: 24px;
    border: 1px solid var(--gold);
    background: transparent;
    color: var(--gold);
    padding: 10px 20px;
    width: auto;
    font-family: inherit;
}

#welcome button {
    width: 85%;
    max-width: 400px;
    padding: 15px 0;
    margin-top: 12px;
}

.modal-content button {
    width: 100%;
    margin-top: 10px;
    padding: 12px 0;
}

/* Tabel Anti-Bingkai: Garis Vertikal Lenyap */
table {
  width: 100%;
  border-collapse: collapse;
  table-layout: auto;
  border: none !important;
 
  border-left: 0 !important;
  border-right: 0 !important;
}

th, td {
  padding: 12px 5px;
  font-size: 11px;
  color: #fff;
  border: none !important;
  border-bottom: 1px solid #333 !important;
  /* JANGAN pakai white-space: nowrap di sini secara global */
}

/* 1. Paksa Keterangan buat ganti baris kalau kepanjangan */
td:nth-child(2), th:nth-child(2) {
  white-space: normal !important; /* Biar teks turun ke bawah, gak bocor samping */
  word-break: break-word; /* Potong kata kalau kepanjangan banget */
  min-width: 100px;
}
  .kat-badge { 
    font-size: 9px; 
    color: #aaa; 
    display: block; 
    margin-top: 2px; 
    font-style: italic; 
    text-transform: lowercase;
}

/* 2. Kunci Lebar Nominal biar gak kegeser-geser */
td:nth-child(4), th:nth-child(4) {
  text-align: right;
  padding-right: 10px;
  width: 90px !important; /* Kunci lebar kolom nominal */
  min-width: 90px !important;
  white-space: nowrap; /* Nominal tetep satu baris biar rapi */
}
/* Atur lebar kolom secara manual agar pas di HP */
th:nth-child(1), td:nth-child(1) { width: 45px; } /* Tgl */
th:nth-child(3), td:nth-child(3) { 
  width: 55px; 
  text-align: center !important; /* <--- TAMBAHIN INI */
}
th:nth-child(4), td:nth-child(4) { width: 90px; text-align: right; } /* Nominal */
/* Tambahin ini biar teks gak maksa pindah baris di tengah kata */
th {
  font-size: 11px; /* Font judul lebih kecil biar kata "Keterangan" muat */
  text-transform: uppercase;
  color: var(--gold);
  letter-spacing: 0.5px;
}
button:hover{box-shadow:0 0 20px var(--gold)}
#welcome{height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center}
  #welcome h1{
  font-size:60px;
  margin: 10px 0;
}
#welcome input{margin:6px;width:600px;padding:10px;background:#111;color:#fff;border:1px solid var(--gold);border-radius:10px}
#welcome button{ margin-top:12px }
#main{display:none}
header {
    text-align: center;
    padding: 20px 0 30px 0;
    border-bottom: 1px solid var(--gold);
    width: 95%;
    margin: 0 auto;
    box-sizing: border-box;
}
.card {
    margin: 20px auto;
    width: 95%;
    border-top: 0.5px solid var(--gold);
    border-bottom: 0.5px solid var(--gold);
    border-left: 0;
    border-right: 0;
    box-sizing: border-box;
    padding: 15px 0;
}
.saldo {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.box:nth-child(3) {
  grid-column: 1 / span 2;
  border-color: var(--gold);
}

.box {
    padding: 10px;
    border: 1px solid #333;
    border-radius: 12px;
    text-align: center;
}
.fab {
    position: fixed;
    right: 20px;
    bottom: 20px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--gold);
    color: #000;
    font-size: 28px;
    border: none;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    z-index: 1001;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: move;
    touch-action: none;
    /* Animasi floating dibikin simpel */
    animation: floating 3s ease-in-out infinite;
}

@keyframes floating {
    0%, 100% { margin-bottom: 0; }
    50% { margin-bottom: 10px; }
}

.fab:active {
    transform: scale(0.9);
}

.fab-pop {
    animation: pop 0.3s ease-out;
}

@keyframes pop {
    0% { transform: scale(0.9); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}
.modal{position:fixed;inset:0;display:none;background:rgba(0,0,0,.7);justify-content:center;align-items:center}
.modal-content{background:#000;padding:20px;border:1px solid var(--gold);border-radius:16px;width:300px}
input,select{width:100%;margin-top:8px;padding:8px;background:#111;color:#fff;border:1px solid #333;border-radius:8px}

@media (max-width: 768px) {

  #welcome h1:first-of-type {
    font-size: 20px !important; /* "SELAMAT DATANG DI WEBSITE" */
  }

  #welcome h1:last-of-type {
    font-size: 35px !important; /* "KEUANGAN PRIBADI" */
  }

  #welcome p {
    font-size: 11px;
    padding: 0 20px;
    text-align: center;
  }
  #welcome input, #welcome button {
    width: 85%;
    padding: 12px;
  }

  #welcome button{
    width:90%;
    padding:15px 0;
  }

}
.header-controls {
  display: flex; 
  gap: 10px; 
  justify-content: center; 
  padding: 0 20px;
}
.header-controls select {
  flex: 1; /* Biar lebarnya bagi dua adil */
  margin-top: 0;
}
</style>
</head>
<body>
<div id="loading-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:9999; flex-direction:column; justify-content:center; align-items:center; text-align:center; font-family:sans-serif;">
    <div style="color:#d4af37; font-size:20px; font-weight:bold; letter-spacing:1px; margin-bottom:10px;">HARAP TUNGGU SEBENTAR...</div>
    <div id="loading-msg" style="color:#fff; font-size:13px; opacity:0.8;">Sedang sinkronisasi data...</div>
    </div>
<!-- ===== WELCOME SCREEN ===== -->
<div id="welcome">
  <h1 style="color:var(--gold); font-size:35px;">SELAMAT DATANG DI WEBSITE</h1>
  <h1 style="color:var(--gold); font-size:75px;">KEUANGAN PRIBADI</h1>
  <p>Built and developed by Fajar Ilmanosa Viar . <b>V1.7.3</b> for personal use only. Copyright Â© 2026 . All Rights Reserved</p>
  <input id="email" placeholder="Email Admin">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">LOGIN</button>
</div>

<!-- ===== MAIN APP ===== -->
<div id="main">
<header>
  <h2 style="color:var(--gold); margin-bottom:10px;">KEUANGAN PRIBADI</h2>
  <div class="header-controls">
    <select id="bulan"></select>
    <select id="tahun"></select>
  </div>
</header>

<div class="card saldo">
  <div class="box">ATM<br><strong id="atm">0</strong></div>
  <div class="box">CASH<br><strong id="cash">0</strong></div>
  <div class="box">TOTAL<br><strong id="total">0</strong></div>
</div>

<div class="card">
  <div style="margin-bottom: 15px; display: flex; gap: 10px;">
    <button id="btnModeEdit" onclick="toggleMode('edit')" style="width:auto; padding:8px 15px; font-size:12px;">EDIT</button>
    <button id="btnModeHapus" onclick="toggleMode('hapus')" style="width:auto; padding:8px 15px; font-size:12px;">HAPUS</button>
  </div>
  <table>
<thead><tr><th>Tanggal</th><th>Keterangan</th><th>Metode</th><th>Nominal</th><th></th></tr></thead>
<tbody id="list"></tbody>
</table>
</div>

<button class="fab">+</button>
</div>

<!-- ===== MODAL ===== -->
<div class="modal" id="modal">
<div class="modal-content">
<input id="tglInput" type="date">
<select id="jenis">
  <option value="masuk">Pemasukan</option>
  <option value="keluar">Pengeluaran</option>
</select>
<select id="kategori">
  <option value="umum">ğŸ’³ Umum</option>
  <option value="jajan">â˜• Jajan</option>
  <option value="makan / minum diluar">ğŸ½ï¸ Makan / Minum diluar</option>
  <option value="bahan makanan">ğŸ¥• Bahan makanan</option>
  <option value="belanja bulanan">ğŸ›’ Belanja bulanan</option>
  <option value="token listrik">âš¡ Token listrik</option>
  <option value="wifi">ğŸ›œ Wifi</option>
  <option value="pulsa / kuota">ğŸ“¶ Pulsa / Kuota</option>
  <option value="belanja paket">ğŸ“¦ Belanja paket</option>
  <option value="kesehatan / obat">ğŸ’Š Kesehatan / Obat</option>
  <option value="hadiah / donasi">ğŸ Hadiah / Donasi</option>
  <option value="hobi / liburan">âœˆï¸ Hobi / Liburan</option>
  <option value="transportasi">ğŸš— Transportasi</option>
  <option value="angsuran rumah">ğŸ  Angsuran rumah</option>
  <option value="perbaikan rumah">ğŸ› ï¸ Perbaikan rumah</option>
  <option value="angsuran motor">ğŸ›µ Angsuran motor</option>  
  <option value="perbaikan dan perawatan motor">ğŸ› ï¸ Perbaikan dan perawatan motor</option>
  <option value="bensin motor">â›½ Bensin motor</option>
  <option value="perbaikan dan perawatan inventaris">ğŸ› ï¸ Perbaikan dan perawatan inventaris</option>
  <option value="bensin inventaris">â›½ Bensin inventaris</option>
  <option value="tabungan">ğŸ’° Tabungan</option>
</select>

<select id="metode">
  <option value="atm">ATM</option>
  <option value="cash">Cash</option>
</select>
<input id="ket" placeholder="Keterangan">
<input id="nominal" type="number" placeholder="Nominal">
<button onclick="simpan()">Simpan</button>
<button onclick="closeForm()">Tutup</button>
</div>
</div>

<script>
// Fungsi sakti buat nampilin si satpam
function showLoading(pesan = "Sedang memproses...") {
    document.getElementById("loading-msg").textContent = pesan;
    document.getElementById("loading-overlay").style.display = "flex";
}

// Fungsi buat nyuruh si satpam pergi
function hideLoading() {
    document.getElementById("loading-overlay").style.display = "none";
}
// Inisialisasi Firestore
const db = firebase.firestore();

let atm = 0, cash = 0, data = [], periode = {};
const bulanEl = document.getElementById("bulan"), tahunEl = document.getElementById("tahun");
const bulanNama = ["JANUARI","FEBRUARI","MAARET","APRIL","MEI","JUNI","JULI","AGUSTUS","SEPTEMBER","OKTOBER","NOVEMBER","DESEMBER"];

// Setting Dropdown & Periode
bulanNama.forEach((b, i) => bulanEl.innerHTML += `<option value="${i + 1}">${b}</option>`);
for (let y = 2020; y <= 2035; y++) tahunEl.innerHTML += `<option>${y}</option>`;

periode.bulan = new Date().getMonth() + 1;
periode.tahun = new Date().getFullYear();
bulanEl.value = periode.bulan;
tahunEl.value = periode.tahun;

function key() { return `${periode.tahun}_${periode.bulan}`; }

// Fungsi Ambil Data dari Firebase (Cloud)
async function load() {
    const user = auth.currentUser;
    if (!user) return;

    // 1. Panggil Satpam: Kunci layar total biar gak ada salah input
    showLoading("Sedang sinkronisasi data dari server...");

    try {
        const docRef = db.collection("keuangan").doc(`${user.uid}_${key()}`);
        const doc = await docRef.get();

        if (doc.exists) {
            const cloudData = doc.data();
            atm = cloudData.atm || 0;
            cash = cloudData.cash || 0;
            data = cloudData.transaksi || [];
        } else {
            // Data bulan baru masih kosong
            atm = 0; cash = 0; data = [];
        }

        // 2. Render data ke tabel
        render();

        // 3. PENTING: Pindahkan layar ke Menu Utama HANYA SETELAH data beres
        document.getElementById("welcome").style.display = "none";
        document.getElementById("main").style.display = "block";

    } catch (e) {
        console.error("Error loading:", e);
        alert("Gagal ambil data: " + e.message);
    } finally {
        // 4. Buka kunci layar setelah semua proses selesai
        hideLoading();
    }
}
// Fungsi Simpan Data ke Firebase (Cloud)
async function save() {
    const user = auth.currentUser;
    if (!user) return;

    try {
        // Proses kirim ke Firebase
        await db.collection("keuangan").doc(`${user.uid}_${key()}`).set({
            atm: atm,
            cash: cash,
            transaksi: data,
            lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log("Data berhasil sinkron ke Cloud.");
        
    } catch (e) {
        // Lempar error ke fungsi pemanggil (fungsi simpan)
        // supaya satpam loading gak buru-buru tutup kalau server gagal nerima data
        throw e; 
    }
}
// Fungsi Tampilan (Render)
function f(n) { return new Intl.NumberFormat('id-ID').format(n); }

function render() {
    data.sort((a, b) => new Date(a.tglAsli) - new Date(b.tglAsli));
    document.getElementById("atm").textContent = f(atm);
    document.getElementById("cash").textContent = f(cash);
    document.getElementById("total").textContent = f(atm + cash);
    
    document.getElementById("list").innerHTML = data.map((d, i) => `
        <tr>
            <td>${d.tgl}</td>
<td>
    <div style="font-weight:bold">${d.ket}</div>
    <span class="kat-badge">#${d.kategori || 'umum'}</span>
</td>            <td>${d.metode.toUpperCase()}</td>
            <td style="color:${d.jenis === 'masuk' ? '#00ff00' : '#ff4444'}">
                ${d.jenis === 'masuk' ? '+' : '-'}${f(d.nominal)}
            </td>
            <td>
                ${modeHapus ? `<button style="padding:5px 10px; width:auto; font-size:10px; background:red; color:white; border:none; border-radius:4px;" onclick="hapusData(${i})">X</button>` : ''}
                ${modeEdit ? `<button style="padding:5px 10px; width:auto; font-size:10px; background:blue; color:white; border:none; border-radius:4px;" onclick="bukaEdit(${i})">Edit</button>` : ''}
            </td>
        </tr>
    `).join("");
}

// Event Handlers
bulanEl.onchange = tahunEl.onchange = () => {
    periode.bulan = bulanEl.value;
    periode.tahun = tahunEl.value;
    load();
};

// Fungsi buat munculin dan menutup kotak input (modal)
function openForm() { 
  document.getElementById("modal").style.display = "flex";
  document.getElementById("tglInput").valueAsDate = new Date();
  editIndex = null;
}
function closeForm() { document.getElementById("modal").style.display = "none"; }

async function hapusData(index) {
    if (!confirm("Yakin mau hapus data ini, Jar?")) return;

    // 1. Panggil Satpam
    showLoading("Sedang menghapus data...");

    try {
        const item = data[index];
        // Balikin saldo dulu sebelum dihapus
        if (item.jenis === "masuk") {
            item.metode === "atm" ? atm -= item.nominal : cash -= item.nominal;
        } else {
            item.metode === "atm" ? atm += item.nominal : cash += item.nominal;
        }

        // Buang dari list (array)
        data.splice(index, 1);

        // 2. Simpan ke Cloud (Wajib await biar Satpam nunggu)
        await save();
        
        // 3. Update tampilan
        render();
    } catch (e) {
        alert("Gagal hapus: " + e.message);
        load(); // Refresh data biar saldo gak kacau kalau gagal
    } finally {
        // 4. Lepas Satpam
        hideLoading();
    }
}

// 1. Variabel status
let modeEdit = false;
let modeHapus = false;
let editIndex = null; 

// 2. Fungsi buat mati-nyalain mode
function toggleMode(tipe) {
    if (tipe === 'edit') {
        modeEdit = !modeEdit;
        modeHapus = false;
    } else {
        modeHapus = !modeHapus;
        modeEdit = false;
    }

    const bE = document.getElementById("btnModeEdit");
    const bH = document.getElementById("btnModeHapus");

    // Gaya tombol EDIT
    bE.style.background = modeEdit ? "blue" : "transparent";
    bE.style.color = modeEdit ? "white" : "var(--gold)";
    bE.style.borderColor = modeEdit ? "blue" : "var(--gold)";
    bE.textContent = modeEdit ? "SELESAI" : "EDIT";

    // Gaya tombol HAPUS
    bH.style.background = modeHapus ? "red" : "transparent";
    bH.style.color = modeHapus ? "white" : "var(--gold)";
    bH.style.borderColor = modeHapus ? "red" : "var(--gold)";
    bH.textContent = modeHapus ? "SELESAI" : "HAPUS";

    render();
}

function bukaEdit(index) {
    const item = data[index];
    editIndex = index; 
    
    document.getElementById("tglInput").value = item.tglAsli;
    document.getElementById("jenis").value = item.jenis;
    document.getElementById("metode").value = item.metode;
    document.getElementById("ket").value = item.ket;
    document.getElementById("nominal").value = item.nominal;
  
    document.getElementById("kategori").value = item.kategori || "umum";
    
    document.getElementById("modal").style.display = "flex";
}

async function simpan() {
    const tglPilihan = document.getElementById("tglInput").value;
    const j = document.getElementById("jenis").value;
    const m = document.getElementById("metode").value;
    const n = +document.getElementById("nominal").value;
    const k = document.getElementById("ket").value;
    const kat = document.getElementById("kategori").value;

    if (!n || !k || !tglPilihan) return alert("Isi semua data!");

    // 1. Panggil Satpam
    showLoading("Sedang menyimpan data...");

    try {
        const d = new Date(tglPilihan);
        const tglTabel = `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()}`;

        // Logika EDIT
        if (editIndex !== null) {
            const lama = data[editIndex];
            if (lama.jenis === "masuk") {
                lama.metode === "atm" ? atm -= lama.nominal : cash -= lama.nominal;
            } else {
                lama.metode === "atm" ? atm += lama.nominal : cash += lama.nominal;
            }
            data.splice(editIndex, 1);
        }

        // Hitung saldo baru
        if (j === "masuk") {
            m === "atm" ? atm += n : cash += n;
        } else {
            m === "atm" ? atm -= n : cash -= n;
        }

        data.push({
            tgl: tglTabel,
            ket: k,
            metode: m,
            jenis: j,
            nominal: n,
            tglAsli: tglPilihan,
            kategori: kat
        });

        // 2. Simpan ke Cloud
        await save();

        editIndex = null;
        render();
        closeForm();

        // Kosongkan form
        document.getElementById("nominal").value = "";
        document.getElementById("ket").value = "";

    } catch (e) {
        alert("Gagal simpan: " + e.message);
    } finally {
        // 3. Lepas Satpam
        hideLoading();
    }
}

function login() {
    const email = document.getElementById("email").value;
    const pass = document.getElementById("password").value;

    if (!email || !pass) return alert("Email & Password jangan kosong!");

    showLoading("Sedang memverifikasi admin...");

    auth.signInWithEmailAndPassword(email, pass).catch(e => {
        hideLoading();
        alert("Gagal Login: " + e.message);
    });
}

// KUNCI UTAMA: Urutan Load Data yang bener
auth.onAuthStateChanged(user => {
    if (user) {
        // Jangan buka 'main' dulu! Biarkan load() yang dapet data baru buka pintunya.
        load(); 
    } else {
        document.getElementById("welcome").style.display = "flex";
        document.getElementById("main").style.display = "none";
        hideLoading();
    }
});
</script>
  
<script>
window.addEventListener("beforeunload", function (e) {
  e.preventDefault();
  e.returnValue = "";
});
</script>

<script>
  const fab = document.querySelector('.fab');
let isDragging = false;

function moveFab(e) {
    isDragging = true;
    fab.style.animation = 'none'; // Matiin floating pas ditarik biar gak kedut
    
    // Ambil koordinat jari/mouse
    let x = (e.type === 'touchmove') ? e.touches[0].clientX : e.clientX;
    let y = (e.type === 'touchmove') ? e.touches[0].clientY : e.clientY;

    // Set posisi tepat di tengah kursor/jari
    fab.style.left = (x - 30) + 'px';
    fab.style.top = (y - 30) + 'px';
    fab.style.right = 'auto';
    fab.style.bottom = 'auto';
}

fab.addEventListener('mousedown', () => {
    isDragging = false; // Reset status setiap klik
    window.addEventListener('mousemove', moveFab);
});

fab.addEventListener('touchstart', () => {
    isDragging = false;
    window.addEventListener('touchmove', moveFab, { passive: false });
});

window.addEventListener('mouseup', (e) => {
    window.removeEventListener('mousemove', moveFab);
    if (isDragging) {
        // Efek pop pas dilepas
        fab.classList.add('fab-pop');
        setTimeout(() => {
            fab.classList.remove('fab-pop');
            fab.style.animation = 'floating 3s ease-in-out infinite';
        }, 300);
    }
});

window.addEventListener('touchend', (e) => {
    window.removeEventListener('touchmove', moveFab);
    if (isDragging) {
        fab.classList.add('fab-pop');
        setTimeout(() => {
            fab.classList.remove('fab-pop');
            fab.style.animation = 'floating 3s ease-in-out infinite';
        }, 300);
    }
});

// Biar gak buka form pas abis geser
fab.onclick = function(e) {
    if (isDragging) {
        e.preventDefault();
        e.stopImmediatePropagation();
        return false;
    }
    // Kalau gak drag, jalankan openForm() manual
    openForm();
};
</script>

</body>
</html>



