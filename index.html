<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KEUANGAN PRIBADI V2.0.9</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCcBqGjq9ZN4Cv-pDfNqaJ2QxnqSqzzPHE",
    authDomain: "keuangan-3ae83.firebaseapp.com",
    projectId: "keuangan-3ae83",
    storageBucket: "keuangan-3ae83.firebasestorage.app",
    messagingSenderId: "988326680959",
    appId: "1:988326680959:web:c2c39e4bed6cdf9c66a24a"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  auth.setPersistence(firebase.auth.Auth.Persistence.NONE);
</script>

<style>
:root{--gold:#d4af37;}
body,html{margin:0;height:100%;background:#000;color:#fff;font-family:Segoe UI}
button {
    cursor: pointer;
    border-radius: 24px;
    border: 1px solid var(--gold);
    background: transparent;
    color: var(--gold);
    padding: 10px 20px;
    width: auto;
    font-family: inherit;
}

#welcome button {
    width: 85%;
    max-width: 400px;
    padding: 15px 0;
    margin-top: 12px;
}

.modal-content button {
    width: 100%;
    margin-top: 10px;
    padding: 12px 0;
}

table {
  width: 100%;
  border-collapse: collapse;
  table-layout: auto;
  border: none !important;
}

th, td {
  padding: 12px 5px;
  font-size: 11px;
  color: #fff;
  border: none !important;
  border-bottom: 1px solid #333 !important;
}

td:nth-child(2), th:nth-child(2) {
  white-space: normal !important;
  word-break: break-word;
  min-width: 100px;
}
.kat-badge { 
    font-size: 9px; 
    color: #aaa; 
    display: block; 
    margin-top: 2px; 
    font-style: italic; 
    text-transform: lowercase;
}

td:nth-child(4), th:nth-child(4) {
  text-align: right;
  padding-right: 10px;
  width: 90px !important;
  min-width: 90px !important;
  white-space: nowrap;
}
th:nth-child(1), td:nth-child(1) { width: 45px; } 
th:nth-child(3), td:nth-child(3) { 
  width: 55px; 
  text-align: center !important;
}
th:nth-child(4), td:nth-child(4) { width: 90px; text-align: right; }
th {
  font-size: 11px;
  text-transform: uppercase;
  color: var(--gold);
  letter-spacing: 0.5px;
}
button:hover{box-shadow:0 0 20px var(--gold)}
#welcome{height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center}
#welcome h1{ font-size:60px; margin: 10px 0;}
#welcome input{margin:6px;width:600px;padding:10px;background:#111;color:#fff;border:1px solid var(--gold);border-radius:10px}
#main{display:none}
header {
    text-align: center;
    padding: 20px 0 30px 0;
    border-bottom: 1px solid var(--gold);
    width: 95%;
    margin: 0 auto;
    box-sizing: border-box;
}
.card {
    margin: 20px auto;
    width: 95%;
    border-top: 0.5px solid var(--gold);
    border-bottom: 0.5px solid var(--gold);
    padding: 15px 0;
}
.saldo {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}
.box {
    padding: 10px;
    border: 1px solid #333;
    border-radius: 12px;
    text-align: center;
}
.fab {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--gold);
    color: #000;
    font-size: 14px;
    font-weight: bold;
    border: none;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: move;
    touch-action: none;
}
.joget {
    animation: floating 3s ease-in-out infinite !important;
}
@keyframes floating {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}
.fab:active { transform: scale(0.9); }
.fab-sub {
    display: none;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    color: white;
    border: none;
    font-size: 10px;
    font-weight: bold;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}
.btn-hijau { background: #28a745; }
.btn-biru { background: #007bff; }
.btn-merah { background: #dc3545; }
.fab-pop { animation: pop 0.3s ease-out; }
@keyframes pop {
    0% { transform: scale(0.9); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}
.modal{position:fixed;inset:0;display:none;background:rgba(0,0,0,.7);justify-content:center;align-items:center}
.modal-content{background:#000;padding:20px;border:1px solid var(--gold);border-radius:16px;width:300px}
input,select{width:100%;margin-top:8px;padding:8px;background:#111;color:#fff;border:1px solid #333;border-radius:8px}

@media (max-width: 768px) {
  #welcome h1:first-of-type { font-size: 20px !important; }
  #welcome h1:last-of-type { font-size: 35px !important; }
  #welcome input, #welcome button { width: 85%; }
}
.header-controls { display: flex; gap: 10px; justify-content: center; padding: 0 20px; }
.nav-btn { background: #111; color: var(--gold); border: 1px solid #444; padding: 5px 15px; border-radius: 8px; font-weight: bold; font-size: 16px; }
</style>
</head>
<body>

<div id="loading-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:9999; flex-direction:column; justify-content:center; align-items:center; text-align:center;">
    <div style="color:#d4af37; font-size:20px; font-weight:bold; margin-bottom:10px;">HARAP TUNGGU SEBENTAR...</div>
    <div id="loading-msg" style="color:#fff; font-size:13px; opacity:0.8;">Sedang sinkronisasi data...</div>
</div>

<div id="welcome">
  <h1 style="color:var(--gold); font-size:35px;">SELAMAT DATANG DI WEBSITE</h1>
  <h1 style="color:var(--gold); font-size:75px;">KEUANGAN PRIBADI</h1>
  <p>Built and developed by Fajar Ilmanosa Viar . <b>V2.0.9</b>. Copyright ¬© 2026</p>
  <input id="email" placeholder="Email Admin">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">LOGIN</button>
</div>

<div id="main">
<header>
  <h2 style="color:var(--gold); margin-bottom:10px;">KEUANGAN PRIBADI</h2>
  <div class="header-controls">
    <button class="nav-btn" onclick="pindahBulan(-1)">‚ùÆ</button>
    <select id="bulan"></select>
    <select id="tahun"></select>
    <button class="nav-btn" onclick="pindahBulan(1)">‚ùØ</button>
  </div>
</header>

<div class="card saldo">
  <div class="box">ATM<br><strong id="atm">0</strong></div>
  <div class="box">CASH<br><strong id="cash">0</strong></div>
  <div class="box" style="grid-column: 1 / span 2; text-align: left; padding: 15px; border-color: var(--gold);">
    <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 8px;">
      <span>üéØ TARGET TABUNGAN</span>
      <span id="persenTarget" style="color: var(--gold); font-weight: bold;">0%</span>
    </div>
    <div style="width: 100%; background: #222; height: 10px; border-radius: 5px; overflow: hidden; border: 1px solid #333;">
      <div id="barTarget" style="width: 0%; height: 100%; background: linear-gradient(90deg, #b8860b, var(--gold)); transition: 1s ease;"></div>
    </div>
    <div id="infoTarget" onclick="setTarget()" style="font-size: 10px; color: #aaa; margin-top: 8px; cursor: pointer;">Klik di sini untuk atur target...</div>
  </div>
  <div class="box">TOTAL<br><strong id="total">0</strong></div>
</div>

<div class="card">
  <table>
    <thead><tr><th>Tanggal</th><th>Keterangan</th><th>Metode</th><th>Nominal</th><th></th></tr></thead>
    <tbody id="list"></tbody>
  </table>
</div>

<div id="fab-container" style="position: fixed; right: 20px; bottom: 20px; z-index: 1001; display: flex; flex-direction: column; align-items: center; gap: 12px;">
    <button id="mainFab" class="fab joget">MENU</button>
    <button id="btnTambahFab" class="fab-sub btn-hijau" onclick="openForm()">+</button>
    <button id="btnEditFab" class="fab-sub btn-biru" onclick="toggleMode('edit')">EDIT</button>
    <button id="btnHapusFab" class="fab-sub btn-merah" onclick="toggleMode('hapus')">HAPUS</button>
</div>
</div>

<div class="modal" id="modal">
<div class="modal-content">
<input id="tglInput" type="date">
<select id="jenis"><option value="masuk">Pemasukan</option><option value="keluar">Pengeluaran</option></select>
<select id="kategori"></select>
<select id="metode"><option value="atm">ATM</option><option value="cash">Cash</option></select>
<input id="ket" placeholder="Keterangan">
<input id="nominal" type="number" placeholder="Nominal">
<button onclick="simpan()">Simpan</button>
<button onclick="closeForm()">Tutup</button>
</div>
</div>

<script>
function showLoading(pesan = "Sedang memproses...") {
    document.getElementById("loading-msg").textContent = pesan;
    document.getElementById("loading-overlay").style.display = "flex";
}
function hideLoading() { document.getElementById("loading-overlay").style.display = "none"; }

const db = firebase.firestore();
let atm = 0, cash = 0, data = [], periode = {}, target = 0;
const ikonKategori = { "umum": "üí≥", "jajan": "‚òï", "makan / minum diluar": "üçΩÔ∏è", "bahan makanan": "ü•ï", "belanja bulanan": "üõí", "topup digital": "‚ö°", "wifi": "·Ø§", "pulsa / kuota": "üì∂", "belanja paket": "üì¶", "kesehatan / obat": "üíä", "hadiah / donasi": "üéÅ", "hobi / liburan": "‚úàÔ∏è", "transportasi": "üöó", "angsuran rumah": "üè†", "perbaikan rumah": "üõ†Ô∏è", "angsuran motor": "üõµ", "perbaikan dan perawatan motor": "üõ†Ô∏è", "bensin motor": "‚õΩ", "perbaikan dan perawatan inventaris": "üõ†Ô∏è", "bensin inventaris": "‚õΩ", "hutang": "üí∏", "tabungan": "üí∞" };

const bulanEl = document.getElementById("bulan"), tahunEl = document.getElementById("tahun");
const bulanNama = ["JANUARI","FEBRUARI","MARET","APRIL","MEI","JUNI","JULI","AGUSTUS","SEPTEMBER","OKTOBER","NOVEMBER","DESEMBER"];
bulanNama.forEach((b, i) => bulanEl.innerHTML += `<option value="${i + 1}">${b}</option>`);
for (let y = 2020; y <= 2035; y++) tahunEl.innerHTML += `<option>${y}</option>`;

periode.bulan = new Date().getMonth() + 1;
periode.tahun = new Date().getFullYear();
bulanEl.value = periode.bulan; tahunEl.value = periode.tahun;

function key() { return `${periode.tahun}_${periode.bulan}`; }

async function load() {
    const user = auth.currentUser;
    if (!user) return;
    showLoading("Sedang sinkronisasi data...");
    try {
        const docRef = db.collection("keuangan").doc(`${user.uid}_${key()}`);
        const doc = await docRef.get();

        let tabunganBulanLalu = 0;
        let cekBulan = periode.bulan - 1;
        let cekTahun = periode.tahun;
        let ketemu = false; let batasCek = 0;
        while (!ketemu && batasCek < 12) {
            if (cekBulan < 1) { cekBulan = 12; cekTahun--; }
            const docLaluRef = db.collection("keuangan").doc(`${user.uid}_${cekTahun}_${cekBulan}`);
            const docLalu = await docLaluRef.get();
            if (docLalu.exists) {
                const dataLalu = docLalu.data().transaksi || [];
                tabunganBulanLalu = dataLalu.filter(d => d.kategori === 'tabungan').reduce((sum, item) => sum + item.nominal, 0);
                ketemu = true;
            }
            cekBulan--; batasCek++;
        }
        window.tabunganLalu = tabunganBulanLalu;

        if (doc.exists) {
            const cloudData = doc.data();
            atm = cloudData.atm || 0; cash = cloudData.cash || 0;
            target = cloudData.target || 0; data = cloudData.transaksi || [];
        } else { atm = 0; cash = 0; data = []; }
        render();
        document.getElementById("welcome").style.display = "none";
        document.getElementById("main").style.display = "block";
    } catch (e) { alert(e.message); } finally { hideLoading(); }
}

async function save() {
    const user = auth.currentUser;
    if (!user) return;
    await db.collection("keuangan").doc(`${user.uid}_${key()}`).set({
        atm: atm, cash: cash, target: target, transaksi: data,
        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
    });
}

function f(n) { return new Intl.NumberFormat('id-ID').format(n); }

function render() {
    let tabunganBulanIni = data.filter(d => d.kategori === 'tabungan').reduce((sum, item) => sum + item.nominal, 0);
    let totalTabungan = (window.tabunganLalu || 0) + tabunganBulanIni;
    let persen = target > 0 ? Math.min((totalTabungan / target) * 100, 100) : 0;
    document.getElementById("barTarget").style.width = persen + "%";
    document.getElementById("persenTarget").textContent = Math.round(persen) + "%";
    document.getElementById("infoTarget").textContent = `Terkumpul: Rp ${f(totalTabungan)} / Target: Rp ${f(target)}`;
    document.getElementById("atm").textContent = f(atm);
    document.getElementById("cash").textContent = f(cash);
    document.getElementById("total").textContent = f(atm + cash);
    document.getElementById("list").innerHTML = data.map((d, i) => `
        <tr draggable="${modeEdit ? 'true' : 'false'}" ondragstart="startDrag(${i})" ondragover="allowDrop(event)" ondrop="dropData(${i})" style="cursor: ${modeEdit ? 'move' : 'default'};">
            <td>${d.tgl}</td>
            <td><div style="font-weight:bold">${d.ket}</div><span class="kat-badge">${ikonKategori[d.kategori] || 'üí≥'} ${d.kategori}</span></td>
            <td>${d.metode.toUpperCase()}</td>
            <td style="color:${d.jenis === 'masuk' ? '#00ff00' : '#ff4444'}">${d.jenis === 'masuk' ? '+' : '-'}${f(d.nominal)}</td>
            <td>
                ${modeHapus ? `<button style="padding:5px 10px; background:red; color:white; border:none; border-radius:4px;" onclick="hapusData(${i})">X</button>` : ''}
                ${modeEdit ? `<button style="padding:5px 10px; background:blue; color:white; border:none; border-radius:4px;" onclick="bukaEdit(${i})">Edit</button>` : ''}
            </td>
        </tr>
    `).join("");
}

function pindahBulan(arah) {
    let m = parseInt(bulanEl.value) + arah;
    let y = parseInt(tahunEl.value);
    if (m < 1) { m = 12; y--; } else if (m > 12) { m = 1; y++; }
    bulanEl.value = m; tahunEl.value = y;
    periode.bulan = m; periode.tahun = y;
    load();
}

const kategoriEl = document.getElementById("kategori");
kategoriEl.innerHTML = Object.keys(ikonKategori).map(k => `<option value="${k}">${ikonKategori[k]} ${k.charAt(0).toUpperCase() + k.slice(1)}</option>`).join("");

function openForm() { document.getElementById("modal").style.display = "flex"; document.getElementById("tglInput").valueAsDate = new Date(); editIndex = null; }
function closeForm() { document.getElementById("modal").style.display = "none"; }

async function simpan() {
    const tglPilihan = document.getElementById("tglInput").value;
    const j = document.getElementById("jenis").value;
    const m = document.getElementById("metode").value;
    const n = +document.getElementById("nominal").value;
    const k = document.getElementById("ket").value;
    const kat = document.getElementById("kategori").value;
    if (!n || !k || !tglPilihan) return alert("Lengkapi data!");
    showLoading();
    try {
        const d = new Date(tglPilihan);
        const tglTabel = `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()}`;
        const dataBaru = { tgl: tglTabel, ket: k, metode: m, jenis: j, nominal: n, tglAsli: tglPilihan, kategori: kat };
        if (editIndex !== null) {
            const lama = data[editIndex];
            if (lama.jenis === "masuk") { lama.metode === "atm" ? atm -= lama.nominal : cash -= lama.nominal; }
            else { lama.metode === "atm" ? atm += lama.nominal : cash += lama.nominal; }
            data[editIndex] = dataBaru;
        } else { data.push(dataBaru); }
        if (j === "masuk") { m === "atm" ? atm += n : cash += n; } else { m === "atm" ? atm -= n : cash -= n; }
        await save();
        editIndex = null; render(); closeForm();
    } catch (e) { alert(e.message); } finally { hideLoading(); }
}

async function hapusData(index) {
    if (!confirm("Yakin hapus?")) return;
    showLoading();
    try {
        const item = data[index];
        if (item.jenis === "masuk") { item.metode === "atm" ? atm -= item.nominal : cash -= item.nominal; }
        else { item.metode === "atm" ? atm += item.nominal : cash += item.nominal; }
        data.splice(index, 1);
        await save(); render();
    } catch (e) { alert(e.message); } finally { hideLoading(); }
}

function login() {
    const email = document.getElementById("email").value;
    const pass = document.getElementById("password").value;
    showLoading();
    auth.signInWithEmailAndPassword(email, pass).catch(e => { hideLoading(); alert(e.message); });
}

auth.onAuthStateChanged(user => { if (user) load(); else { document.getElementById("welcome").style.display = "flex"; document.getElementById("main").style.display = "none"; } });

// ==========================================================
// KONTROL FAB DRAG & JOGET
// ==========================================================
const mainFab = document.getElementById('mainFab');
const container = document.getElementById('fab-container');
let isDragging = false;
let modeEdit = false; let modeHapus = false; let editIndex = null;

function moveFab(e) {
    isDragging = true;
    mainFab.style.animation = 'none';
    let x = (e.type === 'touchmove') ? e.touches[0].clientX : e.clientX;
    let y = (e.type === 'touchmove') ? e.touches[0].clientY : e.clientY;
    container.style.left = (x - 30) + 'px';
    container.style.top = (y - 30) + 'px';
    container.style.right = 'auto'; container.style.bottom = 'auto';
}

mainFab.addEventListener('mousedown', () => { isDragging = false; window.addEventListener('mousemove', moveFab); });
mainFab.addEventListener('touchstart', () => { isDragging = false; window.addEventListener('touchmove', moveFab, { passive: false }); });

window.addEventListener('mouseup', endDrag);
window.addEventListener('touchend', endDrag);

function endDrag() {
    window.removeEventListener('mousemove', moveFab);
    window.removeEventListener('touchmove', moveFab);
    if (isDragging) {
        mainFab.classList.add('fab-pop');
        mainFab.style.animation = ""; 
        if (mainFab.textContent === "MENU") {
            mainFab.classList.remove('joget');
            void mainFab.offsetWidth;
            mainFab.classList.add('joget');
        }
        setTimeout(() => { mainFab.classList.remove('fab-pop'); isDragging = false; }, 300);
    }
}

mainFab.onclick = function() { if (!isDragging) toggleFabMenu(); };

function toggleFabMenu() {
    const btnT = document.getElementById("btnTambahFab");
    const btnE = document.getElementById("btnEditFab");
    const btnH = document.getElementById("btnHapusFab");
    const isHidden = window.getComputedStyle(btnT).display === "none";
    if (isHidden) {
        [btnT, btnE, btnH].forEach(btn => { btn.style.display = "block"; btn.classList.add('joget'); });
        mainFab.classList.remove('joget'); mainFab.textContent = "X";
    } else {
        [btnT, btnE, btnH].forEach(btn => { btn.style.display = "none"; btn.classList.remove('joget'); });
        mainFab.textContent = "MENU";
        mainFab.style.animation = ""; void mainFab.offsetWidth; mainFab.classList.add('joget');
    }
}

function toggleMode(tipe) {
    if (tipe === 'edit') { modeEdit = !modeEdit; modeHapus = false; } 
    else { modeHapus = !modeHapus; modeEdit = false; }
    document.getElementById("btnEditFab").textContent = modeEdit ? "OK" : "EDIT";
    document.getElementById("btnHapusFab").textContent = modeHapus ? "OK" : "HAPUS";
    render();
}

function bukaEdit(index) {
    const item = data[index]; editIndex = index;
    document.getElementById("tglInput").value = item.tglAsli;
    document.getElementById("jenis").value = item.jenis;
    document.getElementById("metode").value = item.metode;
    document.getElementById("ket").value = item.ket;
    document.getElementById("nominal").value = item.nominal;
    document.getElementById("kategori").value = item.kategori || "umum";
    document.getElementById("modal").style.display = "flex";
}

function setTarget() {
    let input = prompt("Target (Rp):", target);
    if (input !== null) { target = parseInt(input) || 0; render(); save(); }
}

let indexSumber;
function startDrag(i) { indexSumber = i; }
function allowDrop(e) { e.preventDefault(); }
async function dropData(indexTujuan) {
    const dS = data[indexSumber]; data.splice(indexSumber, 1); data.splice(indexTujuan, 0, dS);
    render(); showLoading("Menyimpan urutan...");
    try { await save(); } catch (e) { alert(e.message); } finally { hideLoading(); }
}
</script>
</body>
</html>
